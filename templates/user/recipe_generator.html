{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="row">
    <!-- Left Side - Recipe Form -->
    <div class="col-lg-5 mb-4">
        <div class="card h-100">
            <div class="card-header pb-0 p-3">
                <h6 class="mb-0">üç≥ Recipe Generator</h6>
                <p class="text-sm mb-0 text-muted">Generate a custom recipe based on your preferences</p>
            </div>
            <div class="card-body p-3">
                <form id="recipeForm">
                    <!-- Time Slider -->
                    <div class="mb-3">
                        <label class="form-label text-sm font-weight-bold">Time Available (minutes)</label>
                        <input type="range" class="form-range" id="timeSlider" min="10" max="240" step="10" value="30">
                        <div class="text-center mt-2">
                            <span id="timeValue" class="badge badge-sm bg-gradient-primary">30 minutes</span>
                        </div>
                    </div>

                    <!-- Number of People -->
                    <div class="mb-3">
                        <label class="form-label text-sm font-weight-bold">Number of People</label>
                        <input type="number" class="form-control" id="numPeople" value="2" min="1" max="20">
                    </div>

                    <!-- Diet Preference -->
                    <div class="mb-3">
                        <label class="form-label text-sm font-weight-bold">Diet Preference</label>
                        <select class="form-select" id="dietPreference">
                            <option value="Regular" selected>Regular</option>
                            <option value="Vegan">Vegan</option>
                            <option value="Vegetarian">Vegetarian</option>
                            <option value="Low Calorie">Low Calorie</option>
                            <option value="Keto">Keto</option>
                            <option value="Gluten Free">Gluten Free</option>
                        </select>
                    </div>

                    <!-- Experience Level -->
                    <div class="mb-3">
                        <label class="form-label text-sm font-weight-bold">Experience Level</label>
                        <select class="form-select" id="experienceLevel">
                            <option value="Beginner" selected>Beginner</option>
                            <option value="Intermediate">Intermediate</option>
                            <option value="Advanced">Advanced</option>
                        </select>
                    </div>

                    <!-- Ingredients -->
                    <div class="mb-3">
                        <label class="form-label text-sm font-weight-bold">Available Ingredients</label>
                        <textarea class="form-control" id="ingredients" rows="4" 
                            placeholder="e.g., chicken, rice, tomatoes, garlic, onions, olive oil"></textarea>
                        <small class="text-muted">Enter ingredients separated by commas</small>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn bg-gradient-primary w-100" id="generateBtn">
                        <i class="ni ni-send me-1"></i> Generate Recipe
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Right Side - Recipe Output -->
    <div class="col-lg-7">
        <div class="card h-100">
            <div class="card-header pb-0 p-3">
                <h6 class="mb-0">Generated Recipe</h6>
            </div>
            <div class="card-body p-3">
                <!-- Loading Spinner -->
                <div id="loadingSpinner" style="display: none;" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-sm">üç≥ Cooking up your recipe...</p>
                </div>
                
                <!-- Recipe Output Area -->
                <div id="recipeOutput" class="recipe-content">
                    <div class="text-center text-muted py-5">
                        <i class="ni ni-book-bookmark" style="font-size: 64px; opacity: 0.3;"></i>
                        <p class="mt-3 text-sm font-weight-bold">Your personalized recipe will appear here</p>
                        <p class="text-xs text-muted">Fill in the form and click "Generate Recipe" to get started!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Recipe Content Styling */
.recipe-content {
    font-family: 'Open Sans', sans-serif;
    line-height: 1.8;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    min-height: 500px;
    max-height: 600px;
    overflow-y: auto;
}

/* Custom Scrollbar */
.recipe-content::-webkit-scrollbar {
    width: 8px;
}

.recipe-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.recipe-content::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
}

.recipe-content::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Range Slider Styling */
.form-range::-webkit-slider-thumb {
    background: #5e72e4;
}

.form-range::-moz-range-thumb {
    background: #5e72e4;
}

/* Form Focus Styling */
.form-control:focus, .form-select:focus {
    border-color: #5e72e4;
    box-shadow: 0 0 0 2px rgba(94, 114, 228, .25);
}

/* Recipe Output Formatting */
#recipeOutput h1, #recipeOutput h2, #recipeOutput h3 {
    color: #344767;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
}

#recipeOutput strong {
    color: #344767;
}

#recipeOutput ul, #recipeOutput ol {
    margin-left: 20px;
    margin-bottom: 15px;
}
</style>

<script>
// Update time slider display in real-time
const timeSlider = document.getElementById('timeSlider');
const timeValue = document.getElementById('timeValue');

timeSlider.addEventListener('input', function() {
    timeValue.textContent = this.value + ' minutes';
});

// Handle form submission
document.getElementById('recipeForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const generateBtn = document.getElementById('generateBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const recipeOutput = document.getElementById('recipeOutput');
    
    // Get form values
    const formData = {
        time_available: document.getElementById('timeSlider').value,
        num_people: document.getElementById('numPeople').value,
        diet_preference: document.getElementById('dietPreference').value,
        experience_level: document.getElementById('experienceLevel').value,
        ingredients: document.getElementById('ingredients').value.trim()
    };
    
    // Validate ingredients
    if (!formData.ingredients) {
        recipeOutput.innerHTML = `
            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Wait!</strong> Please enter some ingredients first.
            </div>
        `;
        recipeOutput.style.display = 'block';
        return;
    }
    
    // Show loading state
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
    loadingSpinner.style.display = 'block';
    recipeOutput.style.display = 'none';
    
    try {
        // Call the API
        const response = await fetch('/recipe/generate/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Format the recipe response with line breaks
            const formattedRecipe = data.response.replace(/\n/g, '<br>');
            recipeOutput.innerHTML = `
                <div class="alert alert-success mb-3">
                    <strong>‚ú® Recipe Generated Successfully!</strong>
                </div>
                <div style="color: #344767; font-size: 14px;">${formattedRecipe}</div>
            `;
        } else {
            // Show error message
            recipeOutput.innerHTML = `
                <div class="alert alert-danger">
                    <strong>‚ùå Error:</strong> ${data.error}
                </div>
            `;
        }
    } catch (error) {
        // Handle network errors
        recipeOutput.innerHTML = `
            <div class="alert alert-danger">
                <strong>‚ùå Connection Error:</strong> ${error.message}
                <br><small>Please make sure the server is running and try again.</small>
            </div>
        `;
    } finally {
        // Reset button state
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="ni ni-send me-1"></i> Generate Recipe';
        loadingSpinner.style.display = 'none';
        recipeOutput.style.display = 'block';
    }
});

// Get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock content %}