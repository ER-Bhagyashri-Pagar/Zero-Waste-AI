{% extends 'base.html' %}
{% load static %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-fluid py-4">
  <div class="row">
    <!-- Expiring Soon Card -->
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 text-uppercase font-weight-bold">Expiring Soon</p>
                <h5 class="font-weight-bolder">10</h5>
                <p class="mb-0">
                  <span class="text-success text-sm font-weight-bolder">+55%</span> since yesterday
                </p>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape bg-gradient-primary shadow-primary text-center rounded-circle">
                <i class="ni ni-calendar-grid-58 text-lg opacity-10" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Waste Prevented Card -->
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 text-uppercase font-weight-bold">Waste Prevented</p>
                <h5 class="font-weight-bolder">750 kg</h5>
                <p class="mb-0">
                  <span class="text-success text-sm font-weight-bolder">+3%</span> since last week
                </p>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape bg-gradient-danger shadow-danger text-center rounded-circle">
                <i class="ni ni-world text-lg opacity-10" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Impact Card -->
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 text-uppercase font-weight-bold">Impact</p>
                <h5 class="font-weight-bolder">1,200 kg</h5>
                <p class="mb-0">
                  <span class="text-danger text-sm font-weight-bolder">-2%</span> CO‚ÇÇ emissions
                </p>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape bg-gradient-success shadow-success text-center rounded-circle">
                <i class="ni ni-planet text-lg opacity-10" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sales Card -->
    <div class="col-xl-3 col-sm-6">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 text-uppercase font-weight-bold">Money Saved</p>
                <h5 class="font-weight-bolder">10,000</h5>
                <p class="mb-0">
                  <span class="text-success text-sm font-weight-bolder">+5%</span> than last month
                </p>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape bg-gradient-warning shadow-warning text-center rounded-circle">
                <i class="ni ni-cart text-lg opacity-10" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
    <div class="row mt-4">
      <div class="col-lg-7 mb-lg-0 mb-4">
        <div class="card z-index-2 h-100 container-fluid">
          <div class="card-header pb-0 pt-3 bg-transparent">
            <h6 class="text-capitalize">Food Items</h6>
            <table class="table align-items-center">
              <tbody>
                {% for item in food_items %}
                  <tr>
                    <td class="w-30">
                      <div class="d-flex px-2 py-1 align-items-center">
                          <div class="d-flex px-2 py-1">
                              <div>
                                <img src="https://media.istockphoto.com/id/995518546/photo/assortment-of-colorful-ripe-tropical-fruits-top-view.jpg?s=612x612&w=0&k=20&c=bz2zksjSPikOYm9I-mG-f8SAQWVpFsR4M_u4K9soLQ0=" class="avatar avatar-sm me-3">
                              </div>
                        <div class="ms-4">
                          <p class="text-xs font-weight-bold mb-0">Food:</p>
                          <h6 class="text-sm mb-0">{{ item.name }}</h6>
                        </div>
                      </div>
                    </td>
                    <td>
                      <div class="text-center">
                        <p class="text-xs font-weight-bold mb-0">Expiry Date:</p>
                        <h6 class="text-sm mb-0">{{ item.expiry_date }}</h6>
                      </div>
                    </td>
                    <td>
                      <div class="text-center">
                        <p class="text-xs font-weight-bold mb-0">Status:</p>
                        <h6 class="text-sm mb-0">
                          <span class="badge {% if item.status == 'expired' %}bg-danger{% elif item.status == 'expiring soon' %}bg-warning{% else %}bg-success{% endif %}">
                            {{ item.status }}
                          </span>
                        </h6>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="col-lg-5">
        <div class="card card-carousel overflow-hidden h-100 p-0">
          <div id="carouselExampleCaptions" class="carousel slide h-100" data-bs-ride="carousel">
            <div class="carousel-inner border-radius-lg h-100">
              <div class="carousel-item h-100 active" style="background-image: url('{% static 'assets/uploads/waste.png'%}');
    background-size: cover;">
                <div class="carousel-caption d-none d-md-block bottom-0 text-start start-0 ms-5">
                  <div class="icon icon-shape icon-sm bg-white text-center border-radius-md mb-3">
                    <i class="ni ni-camera-compact text-dark opacity-10"></i>
                  </div>
                  <h5 class="text-white mb-1">Dont waste food!</h5>
                  <p>AI Chef Recipe</p>
                </div>
              </div>
              
              <div class="carousel-item h-100 active" style="background-image: url('{% static 'assets/uploads/foodwaste.png'%}');
    background-size: cover;">
                <div class="carousel-caption d-none d-md-block bottom-0 text-start start-0 ms-5">
                  <div class="icon icon-shape icon-sm bg-white text-center border-radius-md mb-3">
                    <i class="ni ni-bulb-61 text-dark opacity-10"></i>
                  </div>
                  <h5 class="text-white mb-1">AI Chef Recipe</h5>
                  <p>Dont waste food!</p>
                </div>
              </div>
              <div class="carousel-item h-100 active" style="background-image: url('{% static 'assets/uploads/waste.png'%}');

    background-size: cover;">
                <div class="carousel-caption d-none d-md-block bottom-0 text-start start-0 ms-5">
                  <div class="icon icon-shape icon-sm bg-white text-center border-radius-md mb-3">
                    <i class="ni ni-trophy text-dark opacity-10"></i>
                  </div>
                  <h5 class="text-white mb-1">2nd largest food producer is INDIA</h5>
                  <p>India waste 20% of food annually</p>
                </div>
              </div>
            </div>
            <button class="carousel-control-prev w-5 me-3" type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next w-5 me-3" type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="row mt-4">
      <!-- Bar Chart - Sales by Country (Left Side) -->
      <div class="col-lg-7 mb-lg-0 mb-4">
        <div class="card">
          <div class="card-header pb-0 p-3">
            <div class="d-flex justify-content-between">
              <h6 class="mb-2">Wasted Food</h6>
            </div>
          </div>
          <div class="card mb-3">
            <div class="card-body p-3">
              <div class="chart">
                <canvas id="bar-chart" class="chart-canvas" height="200px"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    
      <!-- Pie Chart - Categories (Right Side) -->
      <div class="col-lg-5">
        <div class="card">
          <div class="card-header pb-0 p-3">
            <h6 class="mb-0">Categories</h6>
          </div>
          <div class="card mb-3">
            <div class="card-body p-3">
              <div class="chart">
                <canvas id="pie-chart" class="chart-canvas" height="300px"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
      
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const data = {
          labels: ["Fruits", "Vegetables", "Dairy", "Bakery", "Meat & Fish"],
          datasets: [
            {
              label: "Wasted Food (kg)",
              data: [200, 150, 80, 70, 60],
              backgroundColor: ["#172b4d", "#11cdef", "#f5365c", "#2dce89", "#fb6340"],
              borderColor: "#333",
              borderWidth: 1
            }
          ]
        };
    
        const config = {
          type: "bar",
          data: data,
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Wastage (kg)"
                }
              }
            },
            plugins: {
              legend: {
                display: true,
                position: "top"
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return context.raw + " kg";
                  }
                }
              }
            }
          }
        };
    
        const ctx = document.getElementById("bar-chart").getContext("2d");
        new Chart(ctx, config);
      });
    </script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const data = {
      labels: ["Fruits", "Vegetables", "Dairy", "Bakery", "Meat & Fish"],
      datasets: [
        {
          label: "Top Wasted Food Categories",
          data: [30, 20, 15, 18, 17],
          backgroundColor: ["#ff6384", "#36a2eb", "#ffce56", "#4bc0c0", "#9966ff"],
          hoverOffset: 4
        }
      ]
    };

    const config = {
      type: "pie",
      data: data,
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: "top",
          },
          tooltip: {
            callbacks: {
              label: function (context) {
                let label = context.label || "";
                if (label) {
                  label += ": ";
                }
                label += context.raw + "%";
                return label;
              }
            }
          }
        }
      }
    };

    const ctx = document.getElementById("pie-chart").getContext("2d");
    new Chart(ctx, config);
  });
</script>

<!-- Floating Chatbot Widget -->
<div id="chatbot-widget">
    <div id="chatbot-toggle" onclick="toggleChat()">
        <span id="chat-icon">üí¨</span>
    </div>
    
    <div id="chatbot-container" style="display: none;">
        <div class="chatbot-header">
            <h5>üç≥ Recipe Assistant</h5>
            <button onclick="toggleChat()" class="close-btn">‚úï</button>
        </div>
        
        <div class="chatbot-messages" id="chatbotMessages">
            <div class="bot-message">
                üëã Hi! I'm your Recipe Assistant. Ask me about recipes, cooking tips, or ingredients!
            </div>
        </div>
        
        <div class="chatbot-loading" id="chatbotLoading" style="display: none;">
            <span>Thinking...</span>
        </div>
        
        <div class="chatbot-input">
            <input 
                type="text" 
                id="chatbotInput" 
                placeholder="Type your message..."
                onkeypress="handleChatKeyPress(event)"
            >
            <button onclick="sendChatMessage()">Send</button>
        </div>
    </div>
</div>

<style>
#chatbot-widget {
    position: fixed;
    bottom: 10px;   /* reduced spacing */
    right: 10px;    /* reduced spacing */
    z-index: 1000;
}


#chatbot-toggle {
   margin-right: 0;
   margin-bottom: 0;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: transform 0.3s;
}

#chatbot-toggle:hover {
    transform: scale(1.1);
}

#chat-icon {
    font-size: 28px;
}

#chatbot-container {
    position: fixed;
    bottom: 100px;
    right: 20px;
    width: 380px;
    height: 500px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.chatbot-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chatbot-header h5 {
    margin: 0;
    font-size: 16px;
}

.close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
}

.chatbot-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
}

.bot-message, .user-message {
    margin-bottom: 15px;
    padding: 12px 16px;
    border-radius: 15px;
    max-width: 80%;
    word-wrap: break-word;
}

.bot-message {
    background: white;
    border: 1px solid #e0e0e0;
    align-self: flex-start;
}

.user-message {
    background: #667eea;
    color: white;
    margin-left: auto;
    text-align: right;
}

.chatbot-loading {
    padding: 10px 20px;
    text-align: center;
    color: #667eea;
    font-style: italic;
}

.chatbot-input {
    display: flex;
    padding: 15px;
    background: white;
    border-top: 1px solid #e0e0e0;
}

.chatbot-input input {
    flex: 1;
    padding: 10px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 20px;
    outline: none;
    font-size: 14px;
}

.chatbot-input input:focus {
    border-color: #667eea;
}

.chatbot-input button {
    margin-left: 10px;
    padding: 10px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
}

.chatbot-input button:hover {
    opacity: 0.9;
}
</style>

<script>
function toggleChat() {
    const container = document.getElementById('chatbot-container');
    const toggle = document.getElementById('chatbot-toggle');
    
    if (container.style.display === 'none') {
        container.style.display = 'flex';
        toggle.style.display = 'none';
    } else {
        container.style.display = 'none';
        toggle.style.display = 'flex';
    }
}

function addChatMessage(message, isUser) {
    const messagesDiv = document.getElementById('chatbotMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = isUser ? 'user-message' : 'bot-message';
    messageDiv.textContent = message;
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendChatMessage();
    }
}

async function sendChatMessage() {
    const input = document.getElementById('chatbotInput');
    const loading = document.getElementById('chatbotLoading');
    const message = input.value.trim();
    
    if (!message) return;
    
    input.disabled = true;
    loading.style.display = 'block';
    
    addChatMessage(message, true);
    input.value = '';
    
    try {
        const response = await fetch('/chatbot/send/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ message: message })
        });
        
        const data = await response.json();
        
        if (data.success) {
            addChatMessage(data.response, false);
        } else {
            addChatMessage('Sorry, I encountered an error. Please try again.', false);
        }
    } catch (error) {
        addChatMessage('Connection error. Please try again.', false);
    } finally {
        input.disabled = false;
        loading.style.display = 'none';
        input.focus();
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock content %}